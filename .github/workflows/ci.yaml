name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install linters
        run: pip install ruff

      - name: Ruff check
        run: ruff check .

      - name: Ruff format check
        run: ruff format --check .

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt pytest

      - name: Run unit tests
        run: python -m pytest tests/ -v

  e2e-test:
    name: E2E Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install Tesseract
        run: sudo apt-get update && sudo apt-get install -y tesseract-ocr

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Run against sample image
        run: |
          output=$(python extract_links.py examples/sample.png)
          echo "$output"

          # Verify all 3 expected URLs are found
          echo "$output" | grep -q "https://example.com/docs/getting-started"
          echo "$output" | grep -q "https://api.example.com/v2/status"
          echo "$output" | grep -q "https://github.com/example-org/example-project/tree/main"
          echo "$output" | grep -q "Found 3 link(s)"

          echo "All assertions passed."

      - name: Run with no args (usage)
        run: |
          python extract_links.py 2>&1 && exit 1 || true

      - name: Run with missing file
        run: |
          output=$(python extract_links.py nonexistent.png 2>&1) || true
          echo "$output" | grep -q "File not found"
          echo "Missing file error handled correctly."

  dco:
    name: DCO (Signed-off-by)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Check DCO sign-off
        uses: tim-actions/dco@f2279e6e62d5a7d9115b0cb8e837b777b1b02e21 # v1.1.0

  license-header:
    name: License Header Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check Apache 2.0 headers
        run: |
          failed=0
          for f in $(find . -name '*.py' -not -path './.venv/*' -not -path './__pycache__/*'); do
            if ! head -20 "$f" | grep -q "Licensed under the Apache License, Version 2.0"; then
              echo "MISSING license header: $f"
              failed=1
            fi
          done
          if [ "$failed" -eq 1 ]; then
            echo "Some files are missing the Apache 2.0 license header."
            exit 1
          fi
          echo "All Python files have license headers."
